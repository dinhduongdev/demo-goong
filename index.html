<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>B·∫£n ƒë·ªì tuy·∫øn xe bu√Ωt</title>
  <link href="https://cdn.jsdelivr.net/npm/@goongmaps/goong-js@1.0.9/dist/goong-js.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@goongmaps/goong-js@1.0.9/dist/goong-js.js"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: Arial; }
    #map { width: 100%; height: 90%; }
    #controls {
      padding: 10px;
      background: #fff;
      position: absolute;
      z-index: 1;
      width: 100%;
    }
    select, button {
      padding: 6px;
      margin: 4px;
    }
  </style>
</head>
<body>

<div id="controls">
  <select id="startSelect">
    <option value="">-- Ch·ªçn tr·∫°m b·∫Øt ƒë·∫ßu --</option>
  </select>
  <select id="endSelect">
    <option value="">-- Ch·ªçn tr·∫°m k·∫øt th√∫c --</option>
  </select>
  <button onclick="showRoute()">Xem tuy·∫øn</button>
</div>

<div id="map"></div>
<!-- Th√™m ƒëo·∫°n n√†y v√†o d∆∞·ªõi div #map -->
<div id="route-info" style="padding: 10px; font-size: 16px; background: #f0f0f0;"></div>


<script>
  const GOONG_API_KEY = 'Your_Key';
  goongjs.accessToken = GOONG_API_KEY;
  const key = "Your_Key";
  const map = new goongjs.Map({
    container: 'map',
    style: 'https://tiles.goong.io/assets/goong_map_web.json',
    center: [106.6824, 10.7698],
    zoom: 14
  });

  const busStops = [
    { name: "Tr·∫°m C√¥ng vi√™n √Çu L·∫°c", lat: 10.7698, lng: 106.6824 },
    { name: "Tr·∫°m Tr∆∞·ªùng ƒêH Khoa h·ªçc T·ª± nhi√™n", lat: 10.7646, lng: 106.6823 },
    { name: "Tr·∫°m ƒê·∫°i h·ªçc S√†i G√≤n", lat: 10.7554, lng: 106.6835 },
    { name: "Tr·∫°m Tr∆∞·ªùng Cƒê Kinh t·∫ø TP.HCM", lat: 10.7650, lng: 106.6765 },
    { name: "Tr·∫°m Ti·ªám c∆°m chay Ph√°p Hoa", lat: 10.7730, lng: 106.6902 },
    { name: "Tr·∫°m Tr∆∞·ªùng Cao ƒê·∫≥ng Ph√°t Thanh Truy·ªÅn H√¨nh", lat: 10.7565, lng: 106.6788 },
    { name: "Tr·∫°m Nh√† h√†ng C√¥ ƒê√†o", lat: 10.7512, lng: 106.6812 },
    { name: "Tr·∫°m Tr∆∞·ªùng ƒêH S√¢n kh·∫•u - ƒêi·ªán ·∫£nh", lat: 10.7770, lng: 106.6905 }
  ];

  // Hi·ªÉn th·ªã marker cho c√°c tr·∫°m
  busStops.forEach(stop => {
    new goongjs.Marker()
      .setLngLat([stop.lng, stop.lat])
      .setPopup(new goongjs.Popup().setText(stop.name))
      .addTo(map);
  });

  // ƒê·ªï danh s√°ch tr·∫°m v√†o dropdown
  const startSelect = document.getElementById("startSelect");
  const endSelect = document.getElementById("endSelect");

  busStops.forEach((stop, index) => {
    const option1 = new Option(stop.name, index);
    const option2 = new Option(stop.name, index);
    startSelect.add(option1);
    endSelect.add(option2);
  });

  function decodePolyline(str) {
    let index = 0, lat = 0, lng = 0, coordinates = [];
    while (index < str.length) {
      let b, shift = 0, result = 0;
      do {
        b = str.charCodeAt(index++) - 63;
        result |= (b & 0x1f) << shift;
        shift += 5;
      } while (b >= 0x20);
      const dlat = (result & 1) ? ~(result >> 1) : (result >> 1);
      lat += dlat;

      shift = 0;
      result = 0;
      do {
        b = str.charCodeAt(index++) - 63;
        result |= (b & 0x1f) << shift;
        shift += 5;
      } while (b >= 0x20);
      const dlng = (result & 1) ? ~(result >> 1) : (result >> 1);
      lng += dlng;

      coordinates.push([lng / 1e5, lat / 1e5]);
    }
    return coordinates;
  }

  function showRoute() {
    const startIndex = startSelect.value;
    const endIndex = endSelect.value;
  
    if (startIndex === "" || endIndex === "") {
      alert("Vui l√≤ng ch·ªçn c·∫£ hai tr·∫°m.");
      return;
    }
  
    const start = busStops[startIndex];
    const end = busStops[endIndex];
  
    const url = `https://rsapi.goong.io/Direction?origin=${start.lat},${start.lng}&destination=${end.lat},${end.lng}&vehicle=car&api_key=${key}`;
  
    fetch(url)
      .then(res => res.json())
      .then(data => {
        if (!data.routes || data.routes.length === 0) {
          throw new Error("Kh√¥ng t√¨m th·∫•y tuy·∫øn ph√π h·ª£p");
        }
  
        const route = data.routes[0];
        const coordinates = decodePolyline(route.overview_polyline.points);
  
        // X√≥a tuy·∫øn c≈© n·∫øu c√≥
        if (map.getSource('route')) {
          map.removeLayer('route');
          map.removeSource('route');
        }
  
        map.addSource('route', {
          type: 'geojson',
          data: {
            type: 'Feature',
            geometry: {
              type: 'LineString',
              coordinates: coordinates
            }
          }
        });
  
        map.addLayer({
          id: 'route',
          type: 'line',
          source: 'route',
          layout: { 'line-join': 'round', 'line-cap': 'round' },
          paint: { 'line-color': '#ff0000', 'line-width': 4 }
        });
  
        map.fitBounds([
          [start.lng, start.lat],
          [end.lng, end.lat]
        ], { padding: 50 });
  
        // üëâ Hi·ªÉn th·ªã th√¥ng tin tuy·∫øn
        document.getElementById('route-info').innerHTML = `
          <strong>Tuy·∫øn ƒë∆∞·ªùng:</strong><br>
          T·ª´: ${route.legs[0].start_address}<br>
          ƒê·∫øn: ${route.legs[0].end_address}<br>
          Qu√£ng ƒë∆∞·ªùng: ${route.legs[0].distance.text}<br>
          Th·ªùi gian di chuy·ªÉn: ${route.legs[0].duration.text}
        `;
      })
      .catch(err => {
        console.error(err);
        alert("L·ªói: " + err.message);
      });
  }
  
</script>
</body>
</html>
